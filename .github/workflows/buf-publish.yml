name: "Buf Build"
on:
  workflow_call:
defaults:
  run:
    shell: bash
jobs:
  buf-build:
    environment: buf-push
    name: "Run buf lint, breaking, build, and push"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-node@v3
      - name: Install yarn
        run: npm install --global yarn

      - name: Install ts-proto version 1.85.0
        run: yarn global add ts-proto@1.85.0

      - uses: bufbuild/buf-setup-action@v1
        with:
          version: '1.6.0'

      - name: Generating the ts code
        working-directory: proto
        run: buf generate --template buf.gen.gogo.yaml buf.build/cheqd/cheqd-protos

      # - name: Setup tmate session
      #   uses: mxschmitt/action-tmate@v3

        
      # - uses: bufbuild/buf-breaking-action@v1
      #   with:
      #     input: proto
      #     against: https://github.com/${GITHUB_REPOSITORY}.git#branch=main

      # - uses: bufbuild/buf-lint-action@v1
      #   with:
      #     input: proto

      - uses: bufbuild/buf-push-action@v1
        with:
          input: "proto"
          buf_token: ${{ secrets.GITHUB_TOKEN }}

      # - name: Buf Push
      #   working-directory: proto
      #   run: |
      #     echo ${{ secrets.BUF_TOKEN }} | buf registry login --username cheqd --token-stdin
      #     buf push

  dispatch:
    name: "Dispatch to ts-proto repo"
    runs-on: ubuntu-latest
    needs: buf-build
    steps:
      - uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.TS_PROTO }}
          repository: cheqd/ts-proto
          event-type: buf-changed
        env:
          token: ${{ secrets.TS_PROTO }}
      
